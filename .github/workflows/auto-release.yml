name: Auto Release Plugin

# Trigger: Run this workflow when code is pushed to your main branch
on:
  push:
    branches:
      - main  # CHANGE THIS if your branch name is different (e.g., main or master)
    paths:
      - 'plugin-update-checker.php' # Only run if the main file (with version number) changes

permissions:
  contents: write # Permission to create releases and tags

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      # 1. Checkout the code
      - name: Checkout Code
        uses: actions/checkout@v3

      # 2. Extract Version from plugin-update-checker.php
      - name: Read Version
        id: get_version
        run: |
          # Grep looks for 'Version:', awk grabs the number, tr removes spaces
          VERSION=$(grep -i "Version:" plugin-update-checker.php | awk -F: '{print $2}' | tr -d '[:space:]')
          echo "Detected Version: $VERSION"
          # Save to GitHub Environment Variable
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      # 3. Check if Tag already exists
      - name: Check Tag Existence
        id: check_tag
        uses: mukunku/tag-exists-action@v1.4.0
        with:
          tag: ${{ env.VERSION }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 4. Prepare and Zip the plugin files (Only if tag is new)
      - name: Build ZIP File
        if: steps.check_tag.outputs.exists == 'false'
        run: |
          # Create a directory to act as the plugin folder
          mkdir plugin-update-checker
          
          # Copy all files into it (using rsync to exclude unwanted files)
          # We exclude .git, .github, and the zip itself to keep it clean
          rsync -av --progress . plugin-update-checker --exclude plugin-update-checker --exclude .git --exclude .github --exclude .gitignore
          
          # Zip the directory
          zip -r plugin-update-checker.zip plugin-update-checker
          
          echo "ZIP file created successfully."

      # 5. Create Release and Upload Asset (Only if tag is new)
      - name: Create Release
        if: steps.check_tag.outputs.exists == 'false'
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ env.VERSION }}
          name: "Release ${{ env.VERSION }}"
          body: "Automatic update for version ${{ env.VERSION }}"
          artifacts: "plugin-update-checker.zip"
          token: ${{ secrets.GITHUB_TOKEN }}
          makeLatest: true